name: Integration tests - API Gateway

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  integration:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Docker Compose plugin (official binary)
        run: |
          set -euo pipefail
          echo "Checking docker compose..."
          if command -v docker >/dev/null 2>&1 && docker compose version >/dev/null 2>&1; then
            echo "docker compose already available"
            exit 0
          fi
          ARCH=$(uname -m)
          case "$ARCH" in
            x86_64|amd64) DOCKER_ARCH=amd64 ;;
            aarch64|arm64) DOCKER_ARCH=arm64 ;;
            *) echo "Unsupported arch: $ARCH"; exit 1 ;;
          esac
          COMPOSE_VER="v2.18.1"
          PLUGINDIR=/usr/local/lib/docker/cli-plugins
          sudo mkdir -p ${PLUGINDIR}
          sudo curl -fsSL "https://github.com/docker/compose/releases/download/${COMPOSE_VER}/docker-compose-linux-${DOCKER_ARCH}" -o ${PLUGINDIR}/docker-compose
          sudo chmod +x ${PLUGINDIR}/docker-compose
          echo "Installed docker compose plugin:"
          docker compose version

      - name: Ensure docker compose is available
        run: |
          docker compose version

      - name: Build and start stack
        run: |
          docker compose up -d --build

      - name: Show containers
        run: docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

      - name: Probe proxied endpoints
        run: |
          set -e
          probes=(
            "http://localhost:3000"
            "http://localhost:5001/health"
            "http://localhost:5002/health"
            "http://localhost:5003/health"
            "http://localhost:5004/health"
            "http://localhost:5005/health"
          )

          for url in "${probes[@]}"; do
            echo "Probing $url"
            if curl -fsS -m 10 "$url" -o -; then
              echo "OK: $url"
            else
              echo "FAILED: $url"
              docker compose logs --no-color
              exit 1
            fi
          done

      - name: Tear down stack (always)
        if: always()
        run: |
          docker compose down -v